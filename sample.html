<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Purchase Order Generator</title>
    <link rel="stylesheet" href="./style.css">
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Purchase Order Generator</h1>
        <p>Generate and manage purchase orders</p>
      </header>

      <div class="controls">
        <button class="generate-btn" onclick="generatePO()">
          Generate Purchase Order
        </button>
      </div>

      <div id="loader" class="loader" style="display: none">Generating Order Draft...</div>

      <div id="orders"></div>
    </div>

    <div id="modal" class="modal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal()">×</button>
        <div class="modal-header">
          <h3 id="modal-title"></h3>
        </div>
        <div id="modal-body"></div>
      </div>
    </div>

    <script>
      async function generatePO() {
        const loader = document.getElementById("loader");
        const ordersContainer = document.getElementById("orders");

        loader.style.display = "block";
        ordersContainer.innerHTML = "";

        try {
          const response = await fetch("http://127.0.0.1:8000/generate-po");
          const data = await response.json();
          loader.style.display = "none";
          renderOrders(data);
        } catch (error) {
          loader.style.display = "none";
          ordersContainer.innerHTML =
            '<p style="color: red; text-align: center;">Error loading data</p>';
        }
      }

      function renderOrders(data) {
        const container = document.getElementById("orders");
        const ordersMap = {};

        data.forEach((item) => {
          if (!ordersMap[item.order_number]) ordersMap[item.order_number] = [];
          ordersMap[item.order_number].push(item);
        });

        Object.entries(ordersMap).forEach(([orderNum, items]) => {
          const suppliers = [
            ...new Set(items.map((item) => item.supplier_name)),
          ];

          const orderCard = document.createElement("div");
          orderCard.className = "order-card";
          orderCard.innerHTML = `
  <div class="order-header">
    <div class="order-info">
      <h3>${orderNum}</h3>
      <p>Suppliers: ${suppliers.join(", ")} • ${items.length} items</p>
    </div>
    <div class="arrow">▼</div>
  </div>

  <div class="order-details">
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Category</th>
          <th>Current</th>
          <th>Suggested</th>
          <th>Action</th>
          <th>Festival</th>
        </tr>
      </thead>
      <tbody>
        ${items
          .map(
            (item) => `
          <tr>
            <td>${item.product_name}</td>
            <td>${item.category}</td>
            <td>${item.current_quantity}</td>
            <td>
              <input id="${item.product_id}" type="number" value="${item.suggested_quantity}" />
            </td>
            <td>
              <button onclick="restoreQuantity('${item.product_id}', ${item.suggested_quantity})">
                Restore
              </button>
            </td>
            <td>
              ${
                item.festival_name
                  ? `<button class="festival-btn"
                       onclick="showFestivalModal('${item.festival_name}', '${item.festival_impact_level}')">
                       View Impact
                     </button>`
                  : "-"
              }
            </td>
          </tr>
        `,
          )
          .join("")}
      </tbody>
    </table>

    <div class="order-footer">
      <button onclick="submitOrder(${items.supplier_name})" class="place-order-btn">
        Place Order
      </button>
    </div>
  </div>
`;

          orderCard
            .querySelector(".order-header")
            .addEventListener("click", () => {
              orderCard.classList.toggle("expanded");
            });

          container.appendChild(orderCard);
        });
      }

      function showFestivalModal(festivalName, impactLevel) {
        const modal = document.getElementById("modal");
        const title = document.getElementById("modal-title");
        const body = document.getElementById("modal-body");

        const impactText =
          impactLevel.charAt(0).toUpperCase() + impactLevel.slice(1);

        title.textContent = festivalName;
        body.innerHTML = `
        <p><strong>Impact Level:</strong> <span class="impact-badge ${impactLevel}">${impactText}</span></p>
        <p>This festival increases demand for this product. Expected demand impact: <strong>${impactText}</strong>.</p>
        <p>Consider adjusting stock levels to meet the increased demand during this period.</p>
      `;

        modal.style.display = "block";
      }

      function closeModal() {
        document.getElementById("modal").style.display = "none";
      }

      window.onclick = function (event) {
        const modal = document.getElementById("modal");
        if (event.target == modal) {
          closeModal();
        }
      };

      function restoreQuantity(productId, suggestedQty) {
        const input = document.getElementById(productId);
        if (input) {
          input.value = suggestedQty;
        }
      }

      function submitOrder(supplier_name){
        alert("Order placed");
      }
    </script>
  </body>
</html>
